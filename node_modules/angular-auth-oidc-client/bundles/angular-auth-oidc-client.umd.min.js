!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("@angular/router"),require("rxjs/BehaviorSubject"),require("rxjs/Observable"),require("rxjs/operators"),require("jsrsasign")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","@angular/router","rxjs/BehaviorSubject","rxjs/Observable","rxjs/operators","jsrsasign"],factory):factory((global.ng=global.ng||{},global.ng.angularAuthOidcClient=global.ng.angularAuthOidcClient||{}),global.ng.core,global.ng.common,global.ng.common.http,global.ng.router,global.Rx,global.Rx,global.Rx.Observable.prototype,global.jsrsasign)}(this,function(exports,_angular_core,_angular_common,_angular_common_http,_angular_router,rxjs_BehaviorSubject,rxjs_Observable,rxjs_operators,jsrsasign){"use strict";var __generator=function(thisArg,body){function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=y[2&op[0]?"return":op[0]?"throw":"next"])&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[0,t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(t=_.trys,!(t=t.length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g},__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},OidcConfigService=function(){function OidcConfigService(){this.onConfigurationLoaded=new _angular_core.EventEmitter}return OidcConfigService.prototype.load=function(configUrl){return __awaiter(this,void 0,void 0,function(){var response,_a,err_1;return __generator(this,function(_b){switch(_b.label){case 0:return _b.trys.push([0,4,,5]),[4,fetch(configUrl)];case 1:if(response=_b.sent(),!response.ok)throw new Error(response.statusText);return _a=this,[4,response.json()];case 2:return _a.clientConfiguration=_b.sent(),[4,this.load_using_stsServer(this.clientConfiguration.stsServer)];case 3:return _b.sent(),[3,5];case 4:return err_1=_b.sent(),console.error("OidcConfigService 'load' threw an error on calling "+configUrl,err_1),this.onConfigurationLoaded.emit(!1),[3,5];case 5:return[2]}})})},OidcConfigService.prototype.load_using_stsServer=function(stsServer){return __awaiter(this,void 0,void 0,function(){var response,_a,err_2;return __generator(this,function(_b){switch(_b.label){case 0:return _b.trys.push([0,3,,4]),[4,fetch(stsServer+"/.well-known/openid-configuration")];case 1:if(response=_b.sent(),!response.ok)throw new Error(response.statusText);return _a=this,[4,response.json()];case 2:return _a.wellKnownEndpoints=_b.sent(),this.onConfigurationLoaded.emit(!0),[3,4];case 3:return err_2=_b.sent(),console.error("OidcConfigService 'load_using_stsServer' threw an error on calling "+stsServer,err_2),this.onConfigurationLoaded.emit(!1),[3,4];case 4:return[2]}})})},OidcConfigService.prototype.load_using_custom_stsServer=function(stsServer){return __awaiter(this,void 0,void 0,function(){var response,_a,err_3;return __generator(this,function(_b){switch(_b.label){case 0:return _b.trys.push([0,3,,4]),[4,fetch(stsServer)];case 1:if(response=_b.sent(),!response.ok)throw new Error(response.statusText);return _a=this,[4,response.json()];case 2:return _a.wellKnownEndpoints=_b.sent(),this.onConfigurationLoaded.emit(!0),[3,4];case 3:return err_3=_b.sent(),console.error("OidcConfigService 'load_using_custom_stsServer' threw an error on calling "+stsServer,err_3),this.onConfigurationLoaded.emit(!1),[3,4];case 4:return[2]}})})},OidcConfigService}();OidcConfigService.decorators=[{type:_angular_core.Injectable}],OidcConfigService.ctorParameters=function(){return[]},OidcConfigService.propDecorators={onConfigurationLoaded:[{type:_angular_core.Output}]};var AuthorizationResult={};AuthorizationResult.authorized=1,AuthorizationResult.forbidden=2,AuthorizationResult.unauthorized=3,AuthorizationResult[AuthorizationResult.authorized]="authorized",AuthorizationResult[AuthorizationResult.forbidden]="forbidden",AuthorizationResult[AuthorizationResult.unauthorized]="unauthorized";var ValidateStateResult=function(){function ValidateStateResult(access_token,id_token,authResponseIsValid,decoded_id_token){void 0===access_token&&(access_token=""),void 0===id_token&&(id_token=""),void 0===authResponseIsValid&&(authResponseIsValid=!1),this.access_token=access_token,this.id_token=id_token,this.authResponseIsValid=authResponseIsValid,this.decoded_id_token=decoded_id_token}return ValidateStateResult}(),DefaultConfiguration=function(){function DefaultConfiguration(){this.stsServer="https://localhost:44318",this.redirect_url="https://localhost:44311",this.client_id="angularclient",this.response_type="id_token token",this.resource="",this.scope="openid email profile",this.hd_param="",this.post_logout_redirect_uri="https://localhost:44311/unauthorized",this.start_checksession=!1,this.silent_renew=!0,this.silent_renew_offset_in_seconds=0,this.silent_redirect_url="https://localhost:44311",this.post_login_route="/",this.forbidden_route="/forbidden",this.unauthorized_route="/unauthorized",this.auto_userinfo=!0,this.log_console_warning_active=!0,this.log_console_debug_active=!1,this.max_id_token_iat_offset_allowed_in_seconds=3,this.storage="undefined"!=typeof Storage?sessionStorage:null}return DefaultConfiguration}(),OpenIDImplicitFlowConfiguration=function(){function OpenIDImplicitFlowConfiguration(){}return OpenIDImplicitFlowConfiguration}(),AuthConfiguration=function(){function AuthConfiguration(defaultConfig){this.defaultConfig=defaultConfig}return Object.defineProperty(AuthConfiguration.prototype,"stsServer",{get:function(){return this.openIDImplicitFlowConfiguration.stsServer||this.defaultConfig.stsServer},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"redirect_url",{get:function(){return this.openIDImplicitFlowConfiguration.redirect_url||this.defaultConfig.redirect_url},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"silent_redirect_url",{get:function(){return this.openIDImplicitFlowConfiguration.silent_renew_url||this.defaultConfig.silent_redirect_url},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"client_id",{get:function(){return this.openIDImplicitFlowConfiguration.client_id||this.defaultConfig.client_id},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"response_type",{get:function(){return this.openIDImplicitFlowConfiguration.response_type||this.defaultConfig.response_type},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"resource",{get:function(){return this.openIDImplicitFlowConfiguration.resource||this.defaultConfig.resource},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"scope",{get:function(){return this.openIDImplicitFlowConfiguration.scope||this.defaultConfig.scope},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"hd_param",{get:function(){return this.openIDImplicitFlowConfiguration.hd_param||this.defaultConfig.hd_param},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"post_logout_redirect_uri",{get:function(){return this.openIDImplicitFlowConfiguration.post_logout_redirect_uri||this.defaultConfig.post_logout_redirect_uri},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"start_checksession",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.start_checksession?this.openIDImplicitFlowConfiguration.start_checksession:this.defaultConfig.start_checksession},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"silent_renew",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.silent_renew?this.openIDImplicitFlowConfiguration.silent_renew:this.defaultConfig.silent_renew},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"silent_renew_offset_in_seconds",{get:function(){return this.openIDImplicitFlowConfiguration.silent_renew_offset_in_seconds||this.defaultConfig.silent_renew_offset_in_seconds},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"post_login_route",{get:function(){return this.openIDImplicitFlowConfiguration.post_login_route||this.defaultConfig.post_login_route},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"forbidden_route",{get:function(){return this.openIDImplicitFlowConfiguration.forbidden_route||this.defaultConfig.forbidden_route},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"unauthorized_route",{get:function(){return this.openIDImplicitFlowConfiguration.unauthorized_route||this.defaultConfig.unauthorized_route},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"auto_userinfo",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.auto_userinfo?this.openIDImplicitFlowConfiguration.auto_userinfo:this.defaultConfig.auto_userinfo},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"auto_clean_state_after_authentication",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.auto_clean_state_after_authentication?this.openIDImplicitFlowConfiguration.auto_clean_state_after_authentication:this.defaultConfig.auto_clean_state_after_authentication},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"trigger_authorization_result_event",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.trigger_authorization_result_event?this.openIDImplicitFlowConfiguration.trigger_authorization_result_event:this.defaultConfig.trigger_authorization_result_event},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"log_console_warning_active",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.log_console_warning_active?this.openIDImplicitFlowConfiguration.log_console_warning_active:this.defaultConfig.log_console_warning_active},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"log_console_debug_active",{get:function(){return void 0!==this.openIDImplicitFlowConfiguration.log_console_debug_active?this.openIDImplicitFlowConfiguration.log_console_debug_active:this.defaultConfig.log_console_debug_active},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"max_id_token_iat_offset_allowed_in_seconds",{get:function(){return this.openIDImplicitFlowConfiguration.max_id_token_iat_offset_allowed_in_seconds||this.defaultConfig.max_id_token_iat_offset_allowed_in_seconds},enumerable:!0,configurable:!0}),Object.defineProperty(AuthConfiguration.prototype,"storage",{get:function(){return this.openIDImplicitFlowConfiguration.storage||this.defaultConfig.storage},enumerable:!0,configurable:!0}),AuthConfiguration.prototype.init=function(openIDImplicitFlowConfiguration){this.openIDImplicitFlowConfiguration=openIDImplicitFlowConfiguration},AuthConfiguration}();AuthConfiguration.decorators=[{type:_angular_core.Injectable}],AuthConfiguration.ctorParameters=function(){return[{type:DefaultConfiguration}]};var OidcSecurityStorage=function(){function OidcSecurityStorage(){}return OidcSecurityStorage.prototype.read=function(key){},OidcSecurityStorage.prototype.write=function(key,value){},OidcSecurityStorage}();OidcSecurityStorage.decorators=[{type:_angular_core.Injectable}],OidcSecurityStorage.ctorParameters=function(){return[]};var BrowserStorage=function(){function BrowserStorage(authConfiguration){this.authConfiguration=authConfiguration,this.hasStorage="undefined"!=typeof Storage}return BrowserStorage.prototype.read=function(key){if(this.hasStorage)return JSON.parse(this.authConfiguration.storage.getItem(key))},BrowserStorage.prototype.write=function(key,value){this.hasStorage&&(value=void 0===value?null:value,this.authConfiguration.storage.setItem(key,JSON.stringify(value)))},BrowserStorage}();BrowserStorage.decorators=[{type:_angular_core.Injectable}],BrowserStorage.ctorParameters=function(){return[{type:AuthConfiguration}]};var OidcSecurityCommon=function(){function OidcSecurityCommon(oidcSecurityStorage){this.oidcSecurityStorage=oidcSecurityStorage,this.storage_auth_result="authorizationResult",this.storage_access_token="authorizationData",this.storage_id_token="authorizationDataIdToken",this.storage_is_authorized="_isAuthorized",this.storage_user_data="userData",this.storage_auth_nonce="authNonce",this.storage_auth_state_control="authStateControl",this.storage_session_state="session_state",this.storage_silent_renew_running="storage_silent_renew_running",this.storage_custom_request_params="storage_custom_request_params"}return Object.defineProperty(OidcSecurityCommon.prototype,"authResult",{get:function(){return this.retrieve(this.storage_auth_result)},set:function(value){this.store(this.storage_auth_result,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"accessToken",{get:function(){return this.retrieve(this.storage_access_token)||""},set:function(value){this.store(this.storage_access_token,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"idToken",{get:function(){return this.retrieve(this.storage_id_token)||""},set:function(value){this.store(this.storage_id_token,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"isAuthorized",{get:function(){return this.retrieve(this.storage_is_authorized)},set:function(value){this.store(this.storage_is_authorized,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"userData",{get:function(){return this.retrieve(this.storage_user_data)},set:function(value){this.store(this.storage_user_data,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"authNonce",{get:function(){return this.retrieve(this.storage_auth_nonce)||""},set:function(value){this.store(this.storage_auth_nonce,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"authStateControl",{get:function(){return this.retrieve(this.storage_auth_state_control)||""},set:function(value){this.store(this.storage_auth_state_control,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"sessionState",{get:function(){return this.retrieve(this.storage_session_state)},set:function(value){this.store(this.storage_session_state,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"silentRenewRunning",{get:function(){return this.retrieve(this.storage_silent_renew_running)||""},set:function(value){this.store(this.storage_silent_renew_running,value)},enumerable:!0,configurable:!0}),Object.defineProperty(OidcSecurityCommon.prototype,"customRequestParams",{get:function(){return this.retrieve(this.storage_custom_request_params)},set:function(value){this.store(this.storage_custom_request_params,value)},enumerable:!0,configurable:!0}),OidcSecurityCommon.prototype.setupModule=function(){},OidcSecurityCommon.prototype.retrieve=function(key){return this.oidcSecurityStorage.read(key)},OidcSecurityCommon.prototype.store=function(key,value){this.oidcSecurityStorage.write(key,value)},OidcSecurityCommon.prototype.resetStorageData=function(isRenewProcess){isRenewProcess||(this.store(this.storage_auth_result,""),this.store(this.storage_session_state,""),this.store(this.storage_silent_renew_running,""),this.store(this.storage_is_authorized,!1),this.store(this.storage_access_token,""),this.store(this.storage_id_token,""),this.store(this.storage_user_data,""))},OidcSecurityCommon.prototype.getAccessToken=function(){return this.retrieve(this.storage_access_token)},OidcSecurityCommon.prototype.getIdToken=function(){return this.retrieve(this.storage_id_token)},OidcSecurityCommon}();OidcSecurityCommon.decorators=[{type:_angular_core.Injectable}],OidcSecurityCommon.ctorParameters=function(){return[{type:OidcSecurityStorage}]};var ArrayHelperService=function(){function ArrayHelperService(){}return ArrayHelperService.prototype.arraysEqual=function(arr1,arr2){if(arr1.length!==arr2.length)return!1;for(var i=arr1.length;i--;)if(arr1[i]!==arr2[i])return!1;return!0},ArrayHelperService}();ArrayHelperService.decorators=[{type:_angular_core.Injectable}],ArrayHelperService.ctorParameters=function(){return[]};var TokenHelperService=function(){function TokenHelperService(){}return TokenHelperService.prototype.getTokenExpirationDate=function(dataIdToken){if(!dataIdToken.hasOwnProperty("exp"))return new Date;var date=new Date(0);return date.setUTCSeconds(dataIdToken.exp),date},TokenHelperService.prototype.getPayloadFromToken=function(token,encode){var data={};if(void 0!==token){var encoded=token.split(".")[1];if(encode)return encoded;data=JSON.parse(this.urlBase64Decode(encoded))}return data},TokenHelperService.prototype.getHeaderFromToken=function(token,encode){var data={};if(void 0!==token){var encoded=token.split(".")[0];if(encode)return encoded;data=JSON.parse(this.urlBase64Decode(encoded))}return data},TokenHelperService.prototype.getSignatureFromToken=function(token,encode){var data={};if(void 0!==token){var encoded=token.split(".")[2];if(encode)return encoded;data=JSON.parse(this.urlBase64Decode(encoded))}return data},TokenHelperService.prototype.urlBase64Decode=function(str){var output=str.replace("-","+").replace("_","/");switch(output.length%4){case 0:break;case 2:output+="==";break;case 3:output+="=";break;default:throw Error("Illegal base64url string!")}return window.atob(output)},TokenHelperService}();TokenHelperService.decorators=[{type:_angular_core.Injectable}],TokenHelperService.ctorParameters=function(){return[]};var LoggerService=function(){function LoggerService(authConfiguration){this.authConfiguration=authConfiguration}return LoggerService.prototype.logError=function(message){console.error(message)},LoggerService.prototype.logWarning=function(message){this.authConfiguration.log_console_warning_active&&console.warn(message)},LoggerService.prototype.logDebug=function(message){this.authConfiguration.log_console_debug_active&&console.log(message)},LoggerService}();LoggerService.decorators=[{type:_angular_core.Injectable}],LoggerService.ctorParameters=function(){return[{type:AuthConfiguration}]};var OidcSecurityValidation=function(){function OidcSecurityValidation(arrayHelperService,tokenHelperService,loggerService){this.arrayHelperService=arrayHelperService,this.tokenHelperService=tokenHelperService,this.loggerService=loggerService}return OidcSecurityValidation.prototype.isTokenExpired=function(token,offsetSeconds){var decoded;return decoded=this.tokenHelperService.getPayloadFromToken(token,!1),!this.validate_id_token_exp_not_expired(decoded,offsetSeconds)},OidcSecurityValidation.prototype.validate_id_token_exp_not_expired=function(decoded_id_token,offsetSeconds){var tokenExpirationDate=this.tokenHelperService.getTokenExpirationDate(decoded_id_token);return offsetSeconds=offsetSeconds||0,!!tokenExpirationDate&&tokenExpirationDate.valueOf()>(new Date).valueOf()+1e3*offsetSeconds},OidcSecurityValidation.prototype.validate_required_id_token=function(dataIdToken){var validated=!0;return dataIdToken.hasOwnProperty("iss")||(validated=!1,this.loggerService.logWarning("iss is missing, this is required in the id_token")),dataIdToken.hasOwnProperty("sub")||(validated=!1,this.loggerService.logWarning("sub is missing, this is required in the id_token")),dataIdToken.hasOwnProperty("aud")||(validated=!1,this.loggerService.logWarning("aud is missing, this is required in the id_token")),dataIdToken.hasOwnProperty("exp")||(validated=!1,this.loggerService.logWarning("exp is missing, this is required in the id_token")),dataIdToken.hasOwnProperty("iat")||(validated=!1,this.loggerService.logWarning("iat is missing, this is required in the id_token")),validated},OidcSecurityValidation.prototype.validate_id_token_iat_max_offset=function(dataIdToken,max_offset_allowed_in_seconds){if(!dataIdToken.hasOwnProperty("iat"))return!1;var dateTime_iat_id_token=new Date(0);return dateTime_iat_id_token.setUTCSeconds(dataIdToken.iat),max_offset_allowed_in_seconds=max_offset_allowed_in_seconds||0,null!=dateTime_iat_id_token&&(this.loggerService.logDebug("validate_id_token_iat_max_offset: "+((new Date).valueOf()-dateTime_iat_id_token.valueOf())+" < "+1e3*max_offset_allowed_in_seconds),(new Date).valueOf()-dateTime_iat_id_token.valueOf()<1e3*max_offset_allowed_in_seconds)},OidcSecurityValidation.prototype.validate_id_token_nonce=function(dataIdToken,local_nonce){return dataIdToken.nonce===local_nonce||(this.loggerService.logDebug("Validate_id_token_nonce failed, dataIdToken.nonce: "+dataIdToken.nonce+" local_nonce:"+local_nonce),!1)},OidcSecurityValidation.prototype.validate_id_token_iss=function(dataIdToken,authWellKnownEndpoints_issuer){return dataIdToken.iss===authWellKnownEndpoints_issuer||(this.loggerService.logDebug("Validate_id_token_iss failed, dataIdToken.iss: "+dataIdToken.iss+" authWellKnownEndpoints issuer:"+authWellKnownEndpoints_issuer),!1)},OidcSecurityValidation.prototype.validate_id_token_aud=function(dataIdToken,aud){if(dataIdToken.aud instanceof Array){return!!this.arrayHelperService.arraysEqual(dataIdToken.aud,aud)||(this.loggerService.logDebug("Validate_id_token_aud  array failed, dataIdToken.aud: "+dataIdToken.aud+" client_id:"+aud),!1)}return dataIdToken.aud===aud||(this.loggerService.logDebug("Validate_id_token_aud failed, dataIdToken.aud: "+dataIdToken.aud+" client_id:"+aud),!1)},OidcSecurityValidation.prototype.validateStateFromHashCallback=function(state,local_state){return state===local_state||(this.loggerService.logDebug("ValidateStateFromHashCallback failed, state: "+state+" local_state:"+local_state),!1)},OidcSecurityValidation.prototype.validate_userdata_sub_id_token=function(id_token_sub,userdata_sub){return id_token_sub===userdata_sub||(this.loggerService.logDebug("validate_userdata_sub_id_token failed, id_token_sub: "+id_token_sub+" userdata_sub:"+userdata_sub),!1)},OidcSecurityValidation.prototype.validate_signature_id_token=function(id_token,jwtkeys){if(!jwtkeys||!jwtkeys.keys)return!1;var header_data=this.tokenHelperService.getHeaderFromToken(id_token,!1);if(0===Object.keys(header_data).length&&header_data.constructor===Object)return this.loggerService.logWarning("id token has no header data"),!1;var kid=header_data.kid;if("RS256"!==header_data.alg)return this.loggerService.logWarning("Only RS256 supported"),!1;var isValid=!1;if(header_data.hasOwnProperty("kid"))for(var _d=0,_e=jwtkeys.keys;_d<_e.length;_d++){var key=_e[_d];if(key.kid===kid){var publickey=jsrsasign.KEYUTIL.getKey(key);return isValid=jsrsasign.KJUR.jws.JWS.verify(id_token,publickey,["RS256"]),isValid||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),isValid}}else{for(var amountOfMatchingKeys=0,_i=0,_a=jwtkeys.keys;_i<_a.length;_i++){var key=_a[_i];"RSA"===key.kty&&"sig"===key.use&&(amountOfMatchingKeys+=1)}if(0===amountOfMatchingKeys)return this.loggerService.logWarning("no keys found, incorrect Signature, validation failed for id_token"),!1;if(amountOfMatchingKeys>1)return this.loggerService.logWarning("no ID Token kid claim in JOSE header and multiple supplied in jwks_uri"),!1;for(var _b=0,_c=jwtkeys.keys;_b<_c.length;_b++){var key=_c[_b];if("RSA"===key.kty&&"sig"===key.use){var publickey=jsrsasign.KEYUTIL.getKey(key);return isValid=jsrsasign.KJUR.jws.JWS.verify(id_token,publickey,["RS256"]),isValid||this.loggerService.logWarning("incorrect Signature, validation failed for id_token"),isValid}}}return isValid},OidcSecurityValidation.prototype.config_validate_response_type=function(response_type){return"id_token token"===response_type||"id_token"===response_type||(this.loggerService.logWarning("module configure incorrect, invalid response_type:"+response_type),!1)},OidcSecurityValidation.prototype.validate_id_token_at_hash=function(access_token,at_hash){this.loggerService.logDebug("From the server:"+at_hash);var testdata=this.generate_at_hash(""+access_token);if(this.loggerService.logDebug("client validation not decoded:"+testdata),testdata===at_hash)return!0;var testValue=this.generate_at_hash(""+decodeURIComponent(access_token));return this.loggerService.logDebug("-gen access--"+testValue),testValue===at_hash},OidcSecurityValidation.prototype.generate_at_hash=function(access_token){var hash=jsrsasign.KJUR.crypto.Util.hashString(access_token,"sha256"),first128bits=hash.substr(0,hash.length/2);return jsrsasign.hextob64u(first128bits)},OidcSecurityValidation}();OidcSecurityValidation.decorators=[{type:_angular_core.Injectable}],OidcSecurityValidation.ctorParameters=function(){return[{type:ArrayHelperService},{type:TokenHelperService},{type:LoggerService}]};var StateValidationService=function(){function StateValidationService(authConfiguration,oidcSecurityCommon,oidcSecurityValidation,tokenHelperService,loggerService){this.authConfiguration=authConfiguration,this.oidcSecurityCommon=oidcSecurityCommon,this.oidcSecurityValidation=oidcSecurityValidation,this.tokenHelperService=tokenHelperService,this.loggerService=loggerService}return StateValidationService.prototype.setupModule=function(authWellKnownEndpoints){this.authWellKnownEndpoints=Object.assign({},authWellKnownEndpoints)},StateValidationService.prototype.validateState=function(result,jwtKeys){var toReturn=new ValidateStateResult("","",!1,{});return this.oidcSecurityValidation.validateStateFromHashCallback(result.state,this.oidcSecurityCommon.authStateControl)?("id_token token"===this.authConfiguration.response_type&&(toReturn.access_token=result.access_token),toReturn.id_token=result.id_token,toReturn.decoded_id_token=this.tokenHelperService.getPayloadFromToken(toReturn.id_token,!1),this.oidcSecurityValidation.validate_signature_id_token(toReturn.id_token,jwtKeys)?this.oidcSecurityValidation.validate_id_token_nonce(toReturn.decoded_id_token,this.oidcSecurityCommon.authNonce)?this.oidcSecurityValidation.validate_required_id_token(toReturn.decoded_id_token)?this.oidcSecurityValidation.validate_id_token_iat_max_offset(toReturn.decoded_id_token,this.authConfiguration.max_id_token_iat_offset_allowed_in_seconds)?this.oidcSecurityValidation.validate_id_token_iss(toReturn.decoded_id_token,this.authWellKnownEndpoints.issuer)?this.oidcSecurityValidation.validate_id_token_aud(toReturn.decoded_id_token,this.authConfiguration.client_id)?this.oidcSecurityValidation.validate_id_token_exp_not_expired(toReturn.decoded_id_token)?"id_token token"!==this.authConfiguration.response_type?(toReturn.authResponseIsValid=!0,this.handleSuccessfulValidation(),toReturn):this.oidcSecurityValidation.validate_id_token_at_hash(toReturn.access_token,toReturn.decoded_id_token.at_hash)&&toReturn.access_token?(toReturn.authResponseIsValid=!0,this.handleSuccessfulValidation(),toReturn):(this.loggerService.logWarning("authorizedCallback incorrect at_hash"),toReturn):(this.loggerService.logWarning("authorizedCallback token expired"),toReturn):(this.loggerService.logWarning("authorizedCallback incorrect aud"),toReturn):(this.loggerService.logWarning("authorizedCallback incorrect iss does not match authWellKnownEndpoints issuer"),toReturn):(this.loggerService.logWarning("authorizedCallback Validation, iat rejected id_token was issued too far away from the current time"),toReturn):(this.loggerService.logDebug("authorizedCallback Validation, one of the REQUIRED properties missing from id_token"),toReturn):(this.loggerService.logWarning("authorizedCallback incorrect nonce"),toReturn):(this.loggerService.logDebug("authorizedCallback Signature validation failed id_token"),toReturn)):(this.loggerService.logWarning("authorizedCallback incorrect state"),toReturn)},StateValidationService.prototype.handleSuccessfulValidation=function(){this.oidcSecurityCommon.authNonce="",this.authConfiguration.auto_clean_state_after_authentication&&(this.oidcSecurityCommon.authStateControl=""),this.loggerService.logDebug("AuthorizedCallback token(s) validated, continue")},StateValidationService}();StateValidationService.decorators=[{type:_angular_core.Injectable}],StateValidationService.ctorParameters=function(){return[{type:AuthConfiguration},{type:OidcSecurityCommon},{type:OidcSecurityValidation},{type:TokenHelperService},{type:LoggerService}]};var OidcSecurityCheckSession=function(){function OidcSecurityCheckSession(authConfiguration,oidcSecurityCommon,loggerService,zone){this.authConfiguration=authConfiguration,this.oidcSecurityCommon=oidcSecurityCommon,this.loggerService=loggerService,this.zone=zone,this.onCheckSessionChanged=new _angular_core.EventEmitter(!0)}return OidcSecurityCheckSession.prototype.setupModule=function(authWellKnownEndpoints){this.authWellKnownEndpoints=Object.assign({},authWellKnownEndpoints)},OidcSecurityCheckSession.prototype.doesSessionExist=function(){var existsparent=void 0;try{var parentdoc=window.parent.document;if(!parentdoc)throw new Error("Unaccessible");existsparent=parentdoc.getElementById("myiFrameForCheckSession")}catch(e){}var exists=window.document.getElementById("myiFrameForCheckSession");return existsparent?this.sessionIframe=existsparent:exists&&(this.sessionIframe=exists),!(!existsparent&&!exists)},OidcSecurityCheckSession.prototype.init=function(){var _this=this;return this.sessionIframe=window.document.createElement("iframe"),this.sessionIframe.id="myiFrameForCheckSession",this.loggerService.logDebug(this.sessionIframe),this.sessionIframe.style.display="none",window.document.body.appendChild(this.sessionIframe),this.sessionIframe.src=this.authWellKnownEndpoints.check_session_iframe,this.iframeMessageEvent=this.messageHandler.bind(this),window.addEventListener("message",this.iframeMessageEvent,!1),rxjs_Observable.Observable.create(function(observer){_this.sessionIframe.onload=function(){observer.next(_this),observer.complete()}})},OidcSecurityCheckSession.prototype.startCheckingSession=function(clientId){this._scheduledHeartBeat||this.pollServerSession(clientId)},OidcSecurityCheckSession.prototype.stopCheckingSession=function(){this._scheduledHeartBeat&&(clearTimeout(this._scheduledHeartBeat),this._scheduledHeartBeat=null)},OidcSecurityCheckSession.prototype.pollServerSession=function(clientId){var _this=this,_pollServerSessionRecur=function(){if(_this.sessionIframe&&clientId){_this.loggerService.logDebug(_this.sessionIframe);var session_state=_this.oidcSecurityCommon.sessionState;session_state&&_this.sessionIframe.contentWindow.postMessage(clientId+" "+session_state,_this.authConfiguration.stsServer)}else _this.loggerService.logWarning("OidcSecurityCheckSession pollServerSession sessionIframe does not exist"),_this.loggerService.logDebug(clientId),
_this.loggerService.logDebug(_this.sessionIframe);_this._scheduledHeartBeat=setTimeout(_pollServerSessionRecur,3e3)};this.zone.runOutsideAngular(function(){_this._scheduledHeartBeat=setTimeout(_pollServerSessionRecur,3e3)})},OidcSecurityCheckSession.prototype.messageHandler=function(e){this.sessionIframe&&e.origin===this.authConfiguration.stsServer&&e.source===this.sessionIframe.contentWindow&&("error"===e.data?this.loggerService.logWarning("error from checksession messageHandler"):"changed"===e.data?this.onCheckSessionChanged.emit():this.loggerService.logDebug(e.data+" from checksession messageHandler"))},OidcSecurityCheckSession}();OidcSecurityCheckSession.decorators=[{type:_angular_core.Injectable}],OidcSecurityCheckSession.ctorParameters=function(){return[{type:AuthConfiguration},{type:OidcSecurityCommon},{type:LoggerService},{type:_angular_core.NgZone}]},OidcSecurityCheckSession.propDecorators={onCheckSessionChanged:[{type:_angular_core.Output}]};var OidcSecuritySilentRenew=function(){function OidcSecuritySilentRenew(loggerService){this.loggerService=loggerService}return OidcSecuritySilentRenew.prototype.initRenew=function(){var existsparent=void 0;try{var parentdoc=window.parent.document;if(!parentdoc)throw new Error("Unaccessible");existsparent=parentdoc.getElementById("myiFrameForSilentRenew")}catch(e){}var exists=window.document.getElementById("myiFrameForSilentRenew");existsparent?this.sessionIframe=existsparent:exists&&(this.sessionIframe=exists),exists||existsparent||(this.sessionIframe=window.document.createElement("iframe"),this.sessionIframe.id="myiFrameForSilentRenew",this.loggerService.logDebug(this.sessionIframe),this.sessionIframe.style.display="none",window.document.body.appendChild(this.sessionIframe))},OidcSecuritySilentRenew.prototype.startRenew=function(url){var _this=this,existsparent=void 0;try{var parentdoc=window.parent.document;if(!parentdoc)throw new Error("Unaccessible");existsparent=parentdoc.getElementById("myiFrameForSilentRenew")}catch(e){}var exists=window.document.getElementById("myiFrameForSilentRenew");return existsparent?this.sessionIframe=existsparent:exists&&(this.sessionIframe=exists),this.loggerService.logDebug("startRenew for URL:"+url),this.sessionIframe.src=url,rxjs_Observable.Observable.create(function(observer){_this.sessionIframe.onload=function(){observer.next(_this),observer.complete()}})},OidcSecuritySilentRenew}();OidcSecuritySilentRenew.decorators=[{type:_angular_core.Injectable}],OidcSecuritySilentRenew.ctorParameters=function(){return[{type:LoggerService}]};var OidcDataService=function(){function OidcDataService(httpClient){this.httpClient=httpClient}return OidcDataService.prototype.getWellknownEndpoints=function(url){var headers=new _angular_common_http.HttpHeaders;return headers=headers.set("Accept","application/json"),this.httpClient.get(url,{headers:headers})},OidcDataService.prototype.getIdentityUserData=function(url,token){var headers=new _angular_common_http.HttpHeaders;return headers=headers.set("Accept","application/json"),headers=headers.set("Authorization","Bearer "+decodeURIComponent(token)),this.httpClient.get(url,{headers:headers})},OidcDataService.prototype.get=function(url){var headers=new _angular_common_http.HttpHeaders;return headers=headers.set("Accept","application/json"),this.httpClient.get(url,{headers:headers})},OidcDataService}();OidcDataService.decorators=[{type:_angular_core.Injectable}],OidcDataService.ctorParameters=function(){return[{type:_angular_common_http.HttpClient}]};var OidcSecurityUserService=function(){function OidcSecurityUserService(oidcDataService,oidcSecurityCommon){this.oidcDataService=oidcDataService,this.oidcSecurityCommon=oidcSecurityCommon,this.userData=""}return OidcSecurityUserService.prototype.setupModule=function(authWellKnownEndpoints){this.authWellKnownEndpoints=Object.assign({},authWellKnownEndpoints)},OidcSecurityUserService.prototype.initUserData=function(){var _this=this;return this.getIdentityUserData().pipe(rxjs_operators.map(function(data){return _this.userData=data}))},OidcSecurityUserService.prototype.getUserData=function(){if(!this.userData)throw Error("UserData is not set!");return this.userData},OidcSecurityUserService.prototype.setUserData=function(value){this.userData=value},OidcSecurityUserService.prototype.getIdentityUserData=function(){var token=this.oidcSecurityCommon.getAccessToken();return this.oidcDataService.getIdentityUserData(this.authWellKnownEndpoints.userinfo_endpoint,token)},OidcSecurityUserService}();OidcSecurityUserService.decorators=[{type:_angular_core.Injectable}],OidcSecurityUserService.ctorParameters=function(){return[{type:OidcDataService},{type:OidcSecurityCommon}]};var UriEncoder=function(){function UriEncoder(){}return UriEncoder.prototype.encodeKey=function(key){return encodeURIComponent(key)},UriEncoder.prototype.encodeValue=function(value){return encodeURIComponent(value)},UriEncoder.prototype.decodeKey=function(key){return decodeURIComponent(key)},UriEncoder.prototype.decodeValue=function(value){return decodeURIComponent(value)},UriEncoder}(),OidcSecurityService=function(){function OidcSecurityService(platformId,oidcDataService,stateValidationService,authConfiguration,router,oidcSecurityCheckSession,oidcSecuritySilentRenew,oidcSecurityUserService,oidcSecurityCommon,oidcSecurityValidation,tokenHelperService,loggerService,zone){this.platformId=platformId,this.oidcDataService=oidcDataService,this.stateValidationService=stateValidationService,this.authConfiguration=authConfiguration,this.router=router,this.oidcSecurityCheckSession=oidcSecurityCheckSession,this.oidcSecuritySilentRenew=oidcSecuritySilentRenew,this.oidcSecurityUserService=oidcSecurityUserService,this.oidcSecurityCommon=oidcSecurityCommon,this.oidcSecurityValidation=oidcSecurityValidation,this.tokenHelperService=tokenHelperService,this.loggerService=loggerService,this.zone=zone,this.onModuleSetup=new _angular_core.EventEmitter,this.onAuthorizationResult=new _angular_core.EventEmitter,this.onCheckSessionChanged=new _angular_core.EventEmitter,this.moduleSetup=!1,this._isAuthorized=new rxjs_BehaviorSubject.BehaviorSubject(!1),this._userData=new rxjs_BehaviorSubject.BehaviorSubject(""),this.authWellKnownEndpointsLoaded=!1}return OidcSecurityService.prototype.setupModule=function(openIDImplicitFlowConfiguration,authWellKnownEndpoints){var _this=this;this.authWellKnownEndpoints=Object.assign({},authWellKnownEndpoints),this.authConfiguration.init(openIDImplicitFlowConfiguration),this.stateValidationService.setupModule(authWellKnownEndpoints),this.oidcSecurityCheckSession.setupModule(authWellKnownEndpoints),this.oidcSecurityUserService.setupModule(authWellKnownEndpoints),this.oidcSecurityCheckSession.onCheckSessionChanged.subscribe(function(){_this.loggerService.logDebug("onCheckSessionChanged"),_this.checkSessionChanged=!0,_this.onCheckSessionChanged.emit(_this.checkSessionChanged)}),this._userData.subscribe(function(){_this.onUserDataChanged()});var userData=this.oidcSecurityCommon.userData;userData&&this.setUserData(userData);var isAuthorized=this.oidcSecurityCommon.isAuthorized;isAuthorized&&(this.loggerService.logDebug("IsAuthorized setup module"),this.loggerService.logDebug(this.oidcSecurityCommon.idToken),this.oidcSecurityValidation.isTokenExpired(this.oidcSecurityCommon.idToken,this.authConfiguration.silent_renew_offset_in_seconds)?this.loggerService.logDebug("IsAuthorized setup module; id_token isTokenExpired"):(this.loggerService.logDebug("IsAuthorized setup module; id_token is valid"),this.setIsAuthorized(isAuthorized),this.runTokenValidation())),this.loggerService.logDebug("STS server: "+this.authConfiguration.stsServer),_angular_common.isPlatformBrowser(this.platformId)?(this.moduleSetup=!0,this.onModuleSetup.emit(),this.authConfiguration.silent_renew&&(this.oidcSecuritySilentRenew.initRenew(),this.boundSilentRenewEvent=this.silentRenewEventHandler.bind(this),window.addEventListener("oidc-silent-renew-message",this.boundSilentRenewEvent,!1)),this.authConfiguration.start_checksession&&!this.oidcSecurityCheckSession.doesSessionExist()&&this.oidcSecurityCheckSession.init().subscribe(function(){_this.oidcSecurityCheckSession.pollServerSession(_this.authConfiguration.client_id)})):(this.moduleSetup=!0,this.onModuleSetup.emit())},OidcSecurityService.prototype.getUserData=function(){return this._userData.asObservable()},OidcSecurityService.prototype.getIsAuthorized=function(){return this._isAuthorized.asObservable()},OidcSecurityService.prototype.getToken=function(){if(!this._isAuthorizedValue)return"";var token=this.oidcSecurityCommon.getAccessToken();return decodeURIComponent(token)},OidcSecurityService.prototype.getIdToken=function(){if(!this._isAuthorizedValue)return"";var token=this.oidcSecurityCommon.getIdToken();return decodeURIComponent(token)},OidcSecurityService.prototype.getPayloadFromIdToken=function(encode){void 0===encode&&(encode=!1);var token=this.getIdToken();return this.tokenHelperService.getPayloadFromToken(token,encode)},OidcSecurityService.prototype.setState=function(state){this.oidcSecurityCommon.authStateControl=state},OidcSecurityService.prototype.getState=function(){return this.oidcSecurityCommon.authStateControl},OidcSecurityService.prototype.setCustomRequestParameters=function(params){this.oidcSecurityCommon.customRequestParams=params},OidcSecurityService.prototype.authorize=function(urlHandler){if(this.authWellKnownEndpoints&&(this.authWellKnownEndpointsLoaded=!0),!this.authWellKnownEndpointsLoaded)return void this.loggerService.logError("Well known endpoints must be loaded before user can login!");if(this.oidcSecurityValidation.config_validate_response_type(this.authConfiguration.response_type)){this.resetAuthorizationData(!1),this.loggerService.logDebug("BEGIN Authorize, no auth data");var state=this.oidcSecurityCommon.authStateControl;state||(state=Date.now()+""+Math.random(),this.oidcSecurityCommon.authStateControl=state);var nonce="N"+Math.random()+Date.now();this.oidcSecurityCommon.authNonce=nonce,this.loggerService.logDebug("AuthorizedController created. local state: "+this.oidcSecurityCommon.authStateControl);var url=this.createAuthorizeUrl(this.authConfiguration.redirect_url,nonce,state,this.authWellKnownEndpoints.authorization_endpoint);urlHandler?urlHandler(url):window.location.href=url}},OidcSecurityService.prototype.authorizedCallback=function(hash){var _this=this,silentRenew=this.oidcSecurityCommon.silentRenewRunning,isRenewProcess="running"===silentRenew;this.loggerService.logDebug("BEGIN authorizedCallback, no auth data"),this.resetAuthorizationData(isRenewProcess),hash=hash||window.location.hash.substr(1);var result=hash.split("&").reduce(function(resultData,item){var parts=item.split("=");return resultData[parts[0]]=parts[1],resultData},{});this.oidcSecurityCommon.authResult=result,this.loggerService.logDebug(result),this.loggerService.logDebug("authorizedCallback created, begin token validation"),this.getSigningKeys().subscribe(function(jwtKeys){var validationResult=_this.getValidatedStateResult(result,jwtKeys);validationResult.authResponseIsValid?(_this.setAuthorizationData(validationResult.access_token,validationResult.id_token),_this.oidcSecurityCommon.silentRenewRunning="",_this.authConfiguration.auto_userinfo?_this.getUserinfo(isRenewProcess,result,validationResult.id_token,validationResult.decoded_id_token).subscribe(function(response){response?(_this.onAuthorizationResult.emit(AuthorizationResult.authorized),_this.authConfiguration.trigger_authorization_result_event||isRenewProcess||_this.router.navigate([_this.authConfiguration.post_login_route])):(_this.onAuthorizationResult.emit(AuthorizationResult.unauthorized),_this.authConfiguration.trigger_authorization_result_event||isRenewProcess||_this.router.navigate([_this.authConfiguration.unauthorized_route]))}):(isRenewProcess||(_this.oidcSecurityUserService.setUserData(validationResult.decoded_id_token),_this.setUserData(_this.oidcSecurityUserService.getUserData()),_this.runTokenValidation()),_this.onAuthorizationResult.emit(AuthorizationResult.authorized),_this.authConfiguration.trigger_authorization_result_event||isRenewProcess||_this.router.navigate([_this.authConfiguration.post_login_route]))):(_this.loggerService.logWarning("authorizedCallback, token(s) validation failed, resetting"),_this.loggerService.logWarning(window.location.hash),_this.resetAuthorizationData(!1),_this.oidcSecurityCommon.silentRenewRunning="",_this.onAuthorizationResult.emit(AuthorizationResult.unauthorized),_this.authConfiguration.trigger_authorization_result_event||isRenewProcess||_this.router.navigate([_this.authConfiguration.unauthorized_route]))},function(err){_this.loggerService.logWarning("Failed to retreive siging key with error: "+JSON.stringify(err)),_this.oidcSecurityCommon.silentRenewRunning=""})},OidcSecurityService.prototype.getUserinfo=function(isRenewProcess,result,id_token,decoded_id_token){var _this=this;return void 0===isRenewProcess&&(isRenewProcess=!1),result=result||this.oidcSecurityCommon.authResult,id_token=id_token||this.oidcSecurityCommon.idToken,decoded_id_token=decoded_id_token||this.tokenHelperService.getPayloadFromToken(id_token,!1),new rxjs_Observable.Observable(function(observer){"id_token token"===_this.authConfiguration.response_type?isRenewProcess?(_this.oidcSecurityCommon.sessionState=result.session_state,observer.next(!0),observer.complete()):_this.oidcSecurityUserService.initUserData().subscribe(function(){_this.loggerService.logDebug("authorizedCallback id_token token flow");var userData=_this.oidcSecurityUserService.getUserData();_this.oidcSecurityValidation.validate_userdata_sub_id_token(decoded_id_token.sub,userData.sub)?(_this.setUserData(userData),_this.loggerService.logDebug(_this.oidcSecurityCommon.accessToken),_this.loggerService.logDebug(_this.oidcSecurityUserService.getUserData()),_this.oidcSecurityCommon.sessionState=result.session_state,_this.runTokenValidation(),observer.next(!0)):(_this.loggerService.logWarning("authorizedCallback, User data sub does not match sub in id_token"),_this.loggerService.logDebug("authorizedCallback, token(s) validation failed, resetting"),_this.resetAuthorizationData(!1),observer.next(!1)),observer.complete()}):(_this.loggerService.logDebug("authorizedCallback id_token flow"),_this.loggerService.logDebug(_this.oidcSecurityCommon.accessToken),_this.oidcSecurityUserService.setUserData(decoded_id_token),_this.setUserData(_this.oidcSecurityUserService.getUserData()),_this.oidcSecurityCommon.sessionState=result.session_state,isRenewProcess||_this.runTokenValidation(),observer.next(!0),observer.complete())})},OidcSecurityService.prototype.logoff=function(){if(this.loggerService.logDebug("BEGIN Authorize, no auth data"),this.authWellKnownEndpoints.end_session_endpoint){var end_session_endpoint=this.authWellKnownEndpoints.end_session_endpoint,id_token_hint=this.oidcSecurityCommon.idToken,url=this.createEndSessionUrl(end_session_endpoint,id_token_hint);this.resetAuthorizationData(!1),this.authConfiguration.start_checksession&&this.checkSessionChanged?this.loggerService.logDebug("only local login cleaned up, server session has changed"):window.location.href=url}else this.resetAuthorizationData(!1),this.loggerService.logDebug("only local login cleaned up, no end_session_endpoint")},OidcSecurityService.prototype.refreshSession=function(){this.loggerService.logDebug("BEGIN refresh session Authorize");var state=this.oidcSecurityCommon.authStateControl;""!==state&&null!==state||(state=Date.now()+""+Math.random(),this.oidcSecurityCommon.authStateControl=state);var nonce="N"+Math.random()+Date.now();this.oidcSecurityCommon.authNonce=nonce,this.loggerService.logDebug("RefreshSession created. adding myautostate: "+this.oidcSecurityCommon.authStateControl);var url=this.createAuthorizeUrl(this.authConfiguration.silent_redirect_url,nonce,state,this.authWellKnownEndpoints.authorization_endpoint,"none");return this.oidcSecurityCommon.silentRenewRunning="running",this.oidcSecuritySilentRenew.startRenew(url)},OidcSecurityService.prototype.handleError=function(error){if(this.loggerService.logError(error),403===error.status||"403"===error.status)this.authConfiguration.trigger_authorization_result_event?this.onAuthorizationResult.emit(AuthorizationResult.unauthorized):this.router.navigate([this.authConfiguration.forbidden_route]);else if(401===error.status||"401"===error.status){var silentRenew=this.oidcSecurityCommon.silentRenewRunning;this.resetAuthorizationData(!!silentRenew),this.authConfiguration.trigger_authorization_result_event?this.onAuthorizationResult.emit(AuthorizationResult.unauthorized):this.router.navigate([this.authConfiguration.unauthorized_route])}},OidcSecurityService.prototype.startCheckingSilentRenew=function(){this.runTokenValidation()},OidcSecurityService.prototype.stopCheckingSilentRenew=function(){this._scheduledHeartBeat&&(clearTimeout(this._scheduledHeartBeat),this._scheduledHeartBeat=null,this.runTokenValidationRunning=!1)},OidcSecurityService.prototype.getValidatedStateResult=function(result,jwtKeys){return result.error?new ValidateStateResult("","",!1,{}):this.stateValidationService.validateState(result,jwtKeys)},OidcSecurityService.prototype.setUserData=function(userData){this.oidcSecurityCommon.userData=userData,this._userData.next(userData)},OidcSecurityService.prototype.setIsAuthorized=function(isAuthorized){this._isAuthorizedValue=isAuthorized,this._isAuthorized.next(isAuthorized)},OidcSecurityService.prototype.setAuthorizationData=function(access_token,id_token){""!==this.oidcSecurityCommon.accessToken&&(this.oidcSecurityCommon.accessToken=""),this.loggerService.logDebug(access_token),this.loggerService.logDebug(id_token),this.loggerService.logDebug("storing to storage, getting the roles"),this.oidcSecurityCommon.accessToken=access_token,this.oidcSecurityCommon.idToken=id_token,this.setIsAuthorized(!0),this.oidcSecurityCommon.isAuthorized=!0},OidcSecurityService.prototype.createAuthorizeUrl=function(redirect_url,nonce,state,authorization_endpoint,prompt){var urlParts=authorization_endpoint.split("?"),authorizationUrl=urlParts[0],params=new _angular_common_http.HttpParams({fromString:urlParts[1],encoder:new UriEncoder});params=params.set("client_id",this.authConfiguration.client_id),params=params.append("redirect_uri",redirect_url),params=params.append("response_type",this.authConfiguration.response_type),params=params.append("scope",this.authConfiguration.scope),params=params.append("nonce",nonce),params=params.append("state",state),prompt&&(params=params.append("prompt",prompt)),this.authConfiguration.hd_param&&(params=params.append("hd",this.authConfiguration.hd_param));var customParams=Object.assign({},this.oidcSecurityCommon.customRequestParams);return Object.keys(customParams).forEach(function(key){params=params.append(key,customParams[key].toString())}),authorizationUrl+"?"+params},OidcSecurityService.prototype.createEndSessionUrl=function(end_session_endpoint,id_token_hint){var urlParts=end_session_endpoint.split("?"),authorizationEndsessionUrl=urlParts[0],params=new _angular_common_http.HttpParams({fromString:urlParts[1],encoder:new UriEncoder});return params=params.set("id_token_hint",id_token_hint),params=params.append("post_logout_redirect_uri",this.authConfiguration.post_logout_redirect_uri),authorizationEndsessionUrl+"?"+params},OidcSecurityService.prototype.resetAuthorizationData=function(isRenewProcess){isRenewProcess||(this.authConfiguration.auto_userinfo&&this.setUserData(""),this.setIsAuthorized(!1),this.oidcSecurityCommon.resetStorageData(isRenewProcess),this.checkSessionChanged=!1)},OidcSecurityService.prototype.onUserDataChanged=function(){this.loggerService.logDebug("onUserDataChanged: last = "+this.lastUserData+", new = "+this._userData.value),this.lastUserData&&!this._userData.value&&this.loggerService.logDebug("onUserDataChanged: Logout detected."),this.lastUserData=this._userData.value},OidcSecurityService.prototype.getSigningKeys=function(){return this.loggerService.logDebug("jwks_uri: "+this.authWellKnownEndpoints.jwks_uri),this.oidcDataService.get(this.authWellKnownEndpoints.jwks_uri).pipe(rxjs_operators.catchError(this.handleErrorGetSigningKeys))},OidcSecurityService.prototype.handleErrorGetSigningKeys=function(error){var errMsg;if(error instanceof Response){var body=error.json()||{},err=JSON.stringify(body);errMsg=error.status+" - "+(error.statusText||"")+" "+err}else errMsg=error.message?error.message:error.toString();return console.error(errMsg),rxjs_Observable.Observable.throw(errMsg)},OidcSecurityService.prototype.runTokenValidation=function(){var _this=this;if(!this.runTokenValidationRunning){this.runTokenValidationRunning=!0;var silentRenewHeartBeatCheck=function(){if(_this._userData.value&&"running"!==_this.oidcSecurityCommon.silentRenewRunning&&_this.getIdToken()&&_this.oidcSecurityValidation.isTokenExpired(_this.oidcSecurityCommon.idToken,_this.authConfiguration.silent_renew_offset_in_seconds)){if(_this.loggerService.logDebug("IsAuthorized: id_token isTokenExpired, start silent renew if active"),_this.authConfiguration.silent_renew)return void _this.refreshSession().subscribe(function(){_this._scheduledHeartBeat=setTimeout(silentRenewHeartBeatCheck,3e3)},function(err){_this.loggerService.logError("Error: "+err),_this._scheduledHeartBeat=setTimeout(silentRenewHeartBeatCheck,3e3)});_this.resetAuthorizationData(!1)}_this._scheduledHeartBeat=setTimeout(silentRenewHeartBeatCheck,3e3)};this.zone.runOutsideAngular(function(){_this._scheduledHeartBeat=setTimeout(silentRenewHeartBeatCheck,1e4)})}},OidcSecurityService.prototype.silentRenewEventHandler=function(e){this.loggerService.logDebug("silentRenewEventHandler"),this.authorizedCallback(e.detail)},OidcSecurityService}();OidcSecurityService.decorators=[{type:_angular_core.Injectable}],OidcSecurityService.ctorParameters=function(){return[{type:Object,decorators:[{type:_angular_core.Inject,args:[_angular_core.PLATFORM_ID]}]},{type:OidcDataService},{type:StateValidationService},{type:AuthConfiguration},{type:_angular_router.Router},{type:OidcSecurityCheckSession},{type:OidcSecuritySilentRenew},{type:OidcSecurityUserService},{type:OidcSecurityCommon},{type:OidcSecurityValidation},{type:TokenHelperService},{type:LoggerService},{type:_angular_core.NgZone}]},OidcSecurityService.propDecorators={onModuleSetup:[{type:_angular_core.Output}],onAuthorizationResult:[{type:_angular_core.Output}],onCheckSessionChanged:[{type:_angular_core.Output}]};var AuthWellKnownEndpoints=function(){function AuthWellKnownEndpoints(){}return AuthWellKnownEndpoints.prototype.setWellKnownEndpoints=function(data){this.issuer=data.issuer,this.jwks_uri=data.jwks_uri,this.authorization_endpoint=data.authorization_endpoint,this.token_endpoint=data.token_endpoint,this.userinfo_endpoint=data.userinfo_endpoint,data.end_session_endpoint&&(this.end_session_endpoint=data.end_session_endpoint),data.check_session_iframe&&(this.check_session_iframe=data.check_session_iframe),data.revocation_endpoint&&(this.revocation_endpoint=data.revocation_endpoint),data.introspection_endpoint&&(this.introspection_endpoint=data.introspection_endpoint)},AuthWellKnownEndpoints}(),JwtKeys=function(){function JwtKeys(){}return JwtKeys}(),JwtKey=function(){function JwtKey(){}return JwtKey}(),AuthModule=function(){function AuthModule(){}return AuthModule.forRoot=function(token){return void 0===token&&(token={}),{ngModule:AuthModule,providers:[OidcConfigService,OidcSecurityService,OidcSecurityValidation,OidcSecurityCheckSession,OidcSecuritySilentRenew,OidcSecurityUserService,OidcSecurityCommon,AuthConfiguration,TokenHelperService,LoggerService,DefaultConfiguration,ArrayHelperService,AuthWellKnownEndpoints,OidcDataService,StateValidationService,{provide:OidcSecurityStorage,useClass:token.storage||BrowserStorage}]}},AuthModule}();AuthModule.decorators=[{type:_angular_core.NgModule}],AuthModule.ctorParameters=function(){return[]},exports.OidcConfigService=OidcConfigService,exports.OidcSecurityService=OidcSecurityService,exports.OidcSecurityStorage=OidcSecurityStorage,exports.BrowserStorage=BrowserStorage,exports.AuthWellKnownEndpoints=AuthWellKnownEndpoints,exports.AuthorizationResult=AuthorizationResult,exports.JwtKeys=JwtKeys,exports.JwtKey=JwtKey,exports.ValidateStateResult=ValidateStateResult,exports.DefaultConfiguration=DefaultConfiguration,exports.OpenIDImplicitFlowConfiguration=OpenIDImplicitFlowConfiguration,exports.AuthConfiguration=AuthConfiguration,exports.AuthModule=AuthModule,exports.OidcSecurityValidation=OidcSecurityValidation,exports.d=ArrayHelperService,exports.a=OidcDataService,exports.b=StateValidationService,exports.e=TokenHelperService,exports.f=LoggerService,exports.g=OidcSecurityCheckSession,exports.c=OidcSecurityCommon,exports.h=OidcSecuritySilentRenew,exports.i=OidcSecurityUserService,Object.defineProperty(exports,"__esModule",{value:!0})});
//# sourceMappingURL=angular-auth-oidc-client.umd.min.js.map
